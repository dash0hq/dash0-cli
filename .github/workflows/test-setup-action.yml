name: Test setup action

on:
  push:
    branches: ['*']
  workflow_dispatch:

jobs:
  # Check whether the minimum supported CLI version (1.1.0) has been released.
  # Jobs that install the CLI depend on this and are skipped until the release exists.
  # TODO: Remove this gate job and all `needs`/`if` references to it once v1.1.0 has been released.
  check-min-version-released:
    name: 'Check if v1.1.0 is released'
    runs-on: ubuntu-latest
    outputs:
      released: ${{ steps.check.outputs.released }}
    steps:
      - name: Check for v1.1.0 tag
        id: check
        run: |
          if git ls-remote --tags https://github.com/dash0hq/dash0-cli.git refs/tags/v1.1.0 | grep -q v1.1.0; then
            echo "released=true" >> $GITHUB_OUTPUT
            echo "v1.1.0 is released"
          else
            echo "released=false" >> $GITHUB_OUTPUT
            echo "v1.1.0 is not yet released â€” dependent jobs will be skipped"
          fi

  test-rejects-old-version:
    name: 'Rejects version below minimum'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI at 1.0.0
        id: setup
        continue-on-error: true
        uses: ./.github/actions/setup
        with:
          version: '1.0.0'
          cache: 'false'

      - name: Verify setup failed
        run: |
          [ "${{ steps.setup.outcome }}" = "failure" ] || { echo "Error: expected failure but got ${{ steps.setup.outcome }}"; exit 1; }

  test-latest-version:
    name: 'Install latest version'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        id: setup
        uses: ./.github/actions/setup
        with:
          cache: 'false'

      - name: Verify binary is on PATH
        run: which dash0

      - name: Verify version output is set
        run: |
          VERSION="${{ steps.setup.outputs.version }}"
          echo "Resolved version: $VERSION"
          [ -n "$VERSION" ] || { echo "Error: version output is empty"; exit 1; }

      - name: Verify version matches
        run: dash0 version | grep "${{ steps.setup.outputs.version }}"

  test-pinned-version:
    name: 'Install pinned version'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        id: setup
        uses: ./.github/actions/setup
        with:
          version: '1.1.0'
          cache: 'false'

      - name: Verify pinned version
        run: |
          dash0 version | grep '1.1.0'
          [ "${{ steps.setup.outputs.version }}" = "1.1.0" ]

  test-pinned-version-v-prefix:
    name: 'Install pinned version (v prefix)'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        id: setup
        uses: ./.github/actions/setup
        with:
          version: 'v1.1.0'
          cache: 'false'

      - name: Verify v prefix is stripped
        run: |
          dash0 version | grep '1.1.0'
          [ "${{ steps.setup.outputs.version }}" = "1.1.0" ]

  test-profile-all-fields:
    name: 'Profile: all fields'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          api-url: 'https://api.example.com'
          otlp-url: 'https://ingress.example.com'
          auth-token: 'auth_test1234567'
          dataset: 'ci-test'
          cache: 'false'

      - name: Verify all fields are set
        run: |
          dash0 config show | grep 'https://api.example.com'
          dash0 config show | grep 'https://ingress.example.com'
          dash0 config show | grep 'ci-test'
          dash0 config show | grep '1234567'

  test-profile-auth-token-only:
    name: 'Profile: auth-token only'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          auth-token: 'auth_onlytoken7'
          cache: 'false'

      - name: Verify auth-token set, others not set
        run: |
          dash0 config show | grep 'lytoken7'
          dash0 config show | grep 'API URL:    (not set)'
          dash0 config show | grep 'OTLP URL:   (not set)'
          dash0 config show | grep 'Dataset:    default'

  test-profile-api-url-only:
    name: 'Profile: api-url only'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          api-url: 'https://api.only.example.com'
          cache: 'false'

      - name: Verify api-url set, others not set
        run: |
          dash0 config show | grep 'https://api.only.example.com'
          dash0 config show | grep 'OTLP URL:   (not set)'
          dash0 config show | grep 'Auth Token: (not set)'
          dash0 config show | grep 'Dataset:    default'

  test-profile-otlp-url-only:
    name: 'Profile: otlp-url only'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          otlp-url: 'https://ingress.only.example.com'
          cache: 'false'

      - name: Verify otlp-url set, others not set
        run: |
          dash0 config show | grep 'https://ingress.only.example.com'
          dash0 config show | grep 'API URL:    (not set)'
          dash0 config show | grep 'Auth Token: (not set)'
          dash0 config show | grep 'Dataset:    default'

  test-profile-dataset-only:
    name: 'Profile: dataset only'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          dataset: 'my-dataset'
          cache: 'false'

      - name: Verify dataset set, others not set
        run: |
          dash0 config show | grep 'Dataset:    my-dataset'
          dash0 config show | grep 'API URL:    (not set)'
          dash0 config show | grep 'OTLP URL:   (not set)'
          dash0 config show | grep 'Auth Token: (not set)'

  test-profile-auth-token-and-api-url:
    name: 'Profile: auth-token + api-url'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          auth-token: 'auth_combo1token'
          api-url: 'https://api.combo1.example.com'
          cache: 'false'

      - name: Verify auth-token and api-url set, others not set
        run: |
          dash0 config show | grep '1token'
          dash0 config show | grep 'https://api.combo1.example.com'
          dash0 config show | grep 'OTLP URL:   (not set)'
          dash0 config show | grep 'Dataset:    default'

  test-profile-auth-token-and-otlp-url:
    name: 'Profile: auth-token + otlp-url'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          auth-token: 'auth_combo2token'
          otlp-url: 'https://ingress.combo2.example.com'
          cache: 'false'

      - name: Verify auth-token and otlp-url set, others not set
        run: |
          dash0 config show | grep '2token'
          dash0 config show | grep 'https://ingress.combo2.example.com'
          dash0 config show | grep 'API URL:    (not set)'
          dash0 config show | grep 'Dataset:    default'

  test-no-profile:
    name: 'No profile when no config inputs'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI without config
        uses: ./.github/actions/setup
        with:
          cache: 'false'

      - name: Verify no profile was created
        run: |
          OUTPUT=$(dash0 config profiles list 2>&1 || true)
          echo "$OUTPUT"
          echo "$OUTPUT" | grep -i 'no profiles'

  test-cache:
    name: 'Binary caching'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: First install (populates cache)
        uses: ./.github/actions/setup

      - name: Remove binary to prove cache works
        run: rm ~/.dash0/bin/dash0

      - name: Second install (should restore from cache)
        uses: ./.github/actions/setup

      - name: Verify binary was restored
        run: dash0 version

  test-arm64:
    name: 'Install on arm64'
    needs: check-min-version-released
    if: needs.check-min-version-released.outputs.released == 'true'
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Dash0 CLI
        uses: ./.github/actions/setup
        with:
          cache: 'false'

      - name: Verify binary runs on arm64
        run: |
          dash0 version
          file ~/.dash0/bin/dash0 | grep 'aarch64\|ARM'
